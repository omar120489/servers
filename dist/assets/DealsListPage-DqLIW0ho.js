import{importShared as R}from"./__federation_fn_import-CJIdJiQv.js";import{j as s}from"./useForkRef-BC7kqYKT.js";import{S as oe,R as se}from"./typeof-1JE7jPjq.js";import{u as re}from"./notistack.esm-68WP7i0D.js";import{M as ne}from"./MainCard-BRoTQIrC.js";import{u as ie,f as A,a as Q,b as O,e as le,c as de,E as ue,F as me}from"./exporters-DztMca4u.js";import{d as U}from"./deals-BUIaxD3R.js";import{B as v}from"./Box-DmbfI6Tx.js";import{T as y}from"./Typography-DFd_zA1D.js";import{C as M}from"./Chip-clCeHopq.js";import{d as C}from"./Button-Bgis-uOM.js";import{T as ce}from"./TextField-HqD_g_zo.js";import{I as fe}from"./InputAdornment-D_aBeDhu.js";import{S as pe}from"./Stack-B5BVBH1D.js";import{A as he}from"./Alert-C9XT2yne.js";import{D as ge}from"./DataGrid-BjTICiuR.js";const{useCallback:j,useEffect:xe,useMemo:ve,useState:L}=await R("react"),X={page:1,size:10,search:""};function ye(a){const[d,F]=L(()=>({...X,...a?.initialQuery??{}})),[P,o]=L(null),[m,b]=L(!1),[c,_]=L(null),h=ve(()=>({...X,...d}),[d]),g=j(async u=>{const l=await U.listDeals(u);o(l),_(null)},[]),t=j(async u=>{b(!0);try{await g(u)}catch(l){throw _(l),l}finally{b(!1)}},[g]);xe(()=>{let u=!0;return b(!0),U.listDeals(h).then(l=>{u&&(o(l),_(null))}).catch(l=>{u&&_(l)}).finally(()=>{u&&b(!1)}),()=>{u=!1}},[h]);const n=j(u=>{F(l=>({...l,...u}))},[]),E=j(u=>{F(l=>({...l,...u(l)}))},[]),i=j(async()=>{await t(h)},[t,h]);return{deals:P?.items??[],data:P,loading:m,error:c,query:h,updateQuery:n,setQuery:E,refetch:i}}const{useCallback:p,useMemo:N,useState:_e}=await R("react"),{Link:k,useSearchParams:be}=await R("react-router-dom"),W=10;function $(a){return a==null||Number.isNaN(a)?"—":new Intl.NumberFormat(void 0,{style:"currency",currency:"USD",maximumFractionDigits:0}).format(a)}function we(a){if(a==null)return"—";const d=a>1?a:a*100;return`${Math.round(d)}%`}function G(a){return a?new Intl.DateTimeFormat(void 0,{year:"numeric",month:"short",day:"numeric"}).format(new Date(a)):"—"}function De(a){if(!a)return"default";const d=a.toLowerCase();return d.includes("won")?"success":d.includes("lost")?"error":d.includes("hold")||d.includes("pending")?"warning":d.includes("negotiation")||d.includes("proposal")?"info":"default"}const Se=[{label:"Close Date",type:"date-range",field:"date"},{label:"Amount",type:"number-range",field:"amount"},{label:"Stages",type:"multi-select",field:"stages",options:[{value:"Lead",label:"Lead"},{value:"Qualified",label:"Qualified"},{value:"Proposal",label:"Proposal"},{value:"Negotiation",label:"Negotiation"},{value:"Closed Won",label:"Closed Won"},{value:"Closed Lost",label:"Closed Lost"}]},{label:"Statuses",type:"multi-select",field:"statuses",options:[{value:"Open",label:"Open"},{value:"Won",label:"Won"},{value:"Lost",label:"Lost"},{value:"Pending",label:"Pending"}]}];function Qe(){const[a,d]=be(),{presets:F,savePreset:P}=ie("deals-filter-presets"),[o,m]=_e({}),b=N(()=>{const e=(S,x)=>{const I=Number(a.get(S));return Number.isFinite(I)&&I>0?I:x},r=S=>{const x=a.get(S);return x&&x.trim().length>0?x:void 0},f=S=>{const x=a.get(S);return x?x.split(","):[]},D={date_from:r("date_from"),date_to:r("date_to"),amount_min:a.get("amount_min")?Number(a.get("amount_min")):void 0,amount_max:a.get("amount_max")?Number(a.get("amount_max")):void 0,stages:f("stages"),statuses:f("statuses")};return m(D),{page:e("page",1),size:e("size",W),search:a.get("search")??"",date_from:r("date_from"),date_to:r("date_to"),amount_min:a.get("amount_min")?Number(a.get("amount_min")):void 0,amount_max:a.get("amount_max")?Number(a.get("amount_max")):void 0,stages:r("stages"),statuses:r("statuses"),stage:r("stage"),ownerId:r("ownerId")}},[a]),{deals:c,data:_,loading:h,error:g,query:t,updateQuery:n,refetch:E}=ye({initialQuery:b}),i=p(e=>{const r=new URLSearchParams(a);for(const[f,D]of Object.entries(e))D===void 0||D===""?r.delete(f):r.set(f,D);d(r)},[a,d]),u=s.jsx(C,{component:k,to:"/deals/new",variant:"contained",children:"New Deal"}),l=s.jsx(C,{component:k,to:"/reports",size:"small",variant:"text",children:"View reports"}),{enqueueSnackbar:w}=re(),z=N(()=>[{field:"id",headerName:"ID"},{field:"name",headerName:"Deal Name"},{field:"amount",headerName:"Amount",valueFormatter:A},{field:"stage",headerName:"Stage"},{field:"status",headerName:"Status"},{field:"closeDate",headerName:"Close Date",valueFormatter:Q},{field:"ownerId",headerName:"Owner"},{field:"grossRevenue",headerName:"Gross Revenue",valueFormatter:A},{field:"directCost",headerName:"Direct Cost",valueFormatter:A},{field:"netProfit",headerName:"Net Profit",valueFormatter:A},{field:"updatedAt",headerName:"Updated",valueFormatter:Q}],[]),q=p(()=>{try{const e=O("deals","xlsx",t.search?{search:t.search}:void 0);le(c,z,e),w(`Exported ${c.length} deals to ${e}`,{variant:"success"})}catch(e){console.error("Export failed:",e),w("Export failed. Please try again.",{variant:"error"})}},[c,z,t.search,w]),B=p(()=>{try{const e=O("deals","pdf",t.search?{search:t.search}:void 0);de(c,z,e,"Deals Report"),w(`Exported ${c.length} deals to ${e}`,{variant:"success"})}catch(e){console.error("Export failed:",e),w("Export failed. Please try again.",{variant:"error"})}},[c,z,t.search,w]),V=N(()=>({page:Math.max(0,(t.page??1)-1),pageSize:t.size??W}),[t.page,t.size]),Y=p(e=>{const r=e.page+1,f=e.pageSize;n({page:r,size:f}),i({page:String(r),size:String(f)})},[i,n]),Z=p(e=>{const r=e.target.value;n({search:r,page:1});const f=r.trim();i({search:f.length>0?r:void 0,page:"1",size:String(t.size??W)})},[t.size,i,n]),H=p(()=>{E()},[E]),J=p(e=>{m(e)},[]),K=p(()=>{const e={page:"1",date_from:o.date_from,date_to:o.date_to,amount_min:o.amount_min===void 0?void 0:String(o.amount_min),amount_max:o.amount_max===void 0?void 0:String(o.amount_max),stages:Array.isArray(o.stages)&&o.stages.length>0?o.stages.join(","):void 0,statuses:Array.isArray(o.statuses)&&o.statuses.length>0?o.statuses.join(","):void 0};i(e),n({...t,page:1,date_from:o.date_from,date_to:o.date_to,amount_min:o.amount_min,amount_max:o.amount_max,stages:Array.isArray(o.stages)&&o.stages.length>0?o.stages.join(","):void 0,statuses:Array.isArray(o.statuses)&&o.statuses.length>0?o.statuses.join(","):void 0})},[o,t,i,n]),ee=p(e=>{m(e)},[]),te=p(()=>{const e=t.size??W;m({}),n({page:1,size:e,search:"",dateFrom:void 0,dateTo:void 0,stage:void 0,ownerId:void 0,date_from:void 0,date_to:void 0,amount_min:void 0,amount_max:void 0,stages:void 0,statuses:void 0}),i({page:"1",size:String(e),search:void 0,dateFrom:void 0,dateTo:void 0,stage:void 0,ownerId:void 0,date_from:void 0,date_to:void 0,amount_min:void 0,amount_max:void 0,stages:void 0,statuses:void 0})},[t.size,i,n]),T=N(()=>{const e=[];return t.date_from&&e.push({key:"date_from",label:`From: ${t.date_from}`,onDelete:()=>{const r={...o,date_from:void 0};m(r),i({date_from:void 0}),n({...t,date_from:void 0})}}),t.date_to&&e.push({key:"date_to",label:`To: ${t.date_to}`,onDelete:()=>{const r={...o,date_to:void 0};m(r),i({date_to:void 0}),n({...t,date_to:void 0})}}),t.amount_min&&e.push({key:"amount_min",label:`Min: ${$(t.amount_min)}`,onDelete:()=>{const r={...o,amount_min:void 0};m(r),i({amount_min:void 0}),n({...t,amount_min:void 0})}}),t.amount_max&&e.push({key:"amount_max",label:`Max: ${$(t.amount_max)}`,onDelete:()=>{const r={...o,amount_max:void 0};m(r),i({amount_max:void 0}),n({...t,amount_max:void 0})}}),t.stages&&e.push({key:"stages",label:`Stages: ${t.stages}`,onDelete:()=>{const r={...o,stages:[]};m(r),i({stages:void 0}),n({...t,stages:void 0})}}),t.statuses&&e.push({key:"statuses",label:`Statuses: ${t.statuses}`,onDelete:()=>{const r={...o,statuses:[]};m(r),i({statuses:void 0}),n({...t,statuses:void 0})}}),e},[t,o,i,n]),ae=N(()=>[{field:"name",headerName:"Deal",flex:1.2,minWidth:200,renderCell:e=>s.jsxs(v,{sx:{display:"flex",flexDirection:"column",gap:.5},children:[s.jsx(y,{variant:"subtitle1",fontWeight:600,noWrap:!0,children:e.row.name}),s.jsxs(y,{variant:"caption",color:"text.secondary",noWrap:!0,children:["Owner: ",e.row.ownerId??"—"]})]})},{field:"amount",headerName:"Amount",flex:.6,minWidth:140,type:"number",renderCell:e=>s.jsx(y,{variant:"body2",noWrap:!0,children:$(e.row.amount)})},{field:"stage",headerName:"Stage",flex:.5,minWidth:140,renderCell:e=>s.jsx(M,{label:e.row.stage||"—",size:"small",variant:"outlined"})},{field:"status",headerName:"Status",flex:.5,minWidth:140,renderCell:e=>s.jsx(M,{label:e.row.status||"—",size:"small",color:De(e.row.status)})},{field:"probability",headerName:"Probability",flex:.4,minWidth:120,renderCell:e=>s.jsx(y,{variant:"body2",noWrap:!0,children:we(e.row.probability)})},{field:"closeDate",headerName:"Close Date",flex:.6,minWidth:150,renderCell:e=>s.jsx(y,{variant:"body2",noWrap:!0,children:G(e.row.closeDate)})},{field:"updatedAt",headerName:"Updated",flex:.6,minWidth:150,renderCell:e=>s.jsx(y,{variant:"body2",noWrap:!0,children:G(e.row.updatedAt)})},{field:"actions",headerName:"Actions",sortable:!1,filterable:!1,minWidth:160,align:"right",disableColumnMenu:!0,renderCell:e=>{const r=s.jsx(C,{component:k,to:`/deals/${e.row.id}`,size:"small",children:"View"}),f=s.jsx(C,{component:k,to:`/deals/${e.row.id}/edit`,size:"small",color:"secondary",children:"Edit"});return s.jsxs(v,{sx:{display:"flex",flexDirection:"row",gap:1},children:[r,f]})}}],[]);return s.jsx(ne,{title:"Deals",content:!1,children:s.jsxs(v,{sx:{display:"flex",flexDirection:"column",gap:2,p:3},children:[s.jsxs(v,{sx:{display:"flex",flexDirection:{xs:"column",md:"row"},gap:2,alignItems:{xs:"stretch",md:"center"},justifyContent:"space-between"},children:[s.jsx(ce,{fullWidth:!0,placeholder:"Search deals",value:t.search??"",onChange:Z,slotProps:{input:{startAdornment:s.jsx(fe,{position:"start",children:s.jsx(oe,{fontSize:"small"})})}}}),s.jsxs(v,{sx:{display:"flex",flexDirection:"row",gap:1.5,justifyContent:{xs:"flex-start",md:"flex-end"}},children:[s.jsx(ue,{onExportXLSX:q,onExportPDF:B,disabled:h||c.length===0}),s.jsx(C,{variant:"outlined",startIcon:s.jsx(se,{}),onClick:H,disabled:h,children:"Refresh"}),u]})]}),s.jsx(me,{filters:Se,values:o,onChange:J,onApply:K,onClear:te,showPresets:!0,presets:F,onSavePreset:P,onLoadPreset:ee}),T.length>0&&s.jsx(pe,{direction:"row",spacing:1,flexWrap:"wrap",sx:{gap:1},children:T.map(e=>s.jsx(M,{label:e.label,onDelete:e.onDelete,color:"primary",size:"small"},e.key))}),!!g&&s.jsxs(he,{severity:"error",children:[g instanceof Error?g.message:"Failed to load deals. Please try again.",g instanceof Error&&g.stack&&s.jsx(y,{component:"pre",variant:"caption",sx:{mt:1,whiteSpace:"pre-wrap"},children:g.stack})]}),s.jsx(v,{sx:{width:"100%"},children:s.jsx(ge,{disableColumnMenu:!0,disableRowSelectionOnClick:!0,rows:c,columns:ae,loading:h,getRowId:e=>e.id,paginationMode:"server",paginationModel:V,onPaginationModelChange:Y,rowCount:_?.total??c.length,pageSizeOptions:[5,10,25,50],sx:{"& .MuiDataGrid-cell":{outline:"none !important"}}})}),s.jsxs(v,{sx:{display:"flex",flexDirection:{xs:"column",sm:"row"},gap:1,alignItems:{xs:"flex-start",sm:"center"}},children:[s.jsxs(y,{variant:"caption",color:"text.secondary",children:["Showing ",c.length," of ",_?.total??0," deals"]}),s.jsx(v,{children:l})]})]})})}export{Qe as default};
//# sourceMappingURL=DealsListPage-DqLIW0ho.js.map
