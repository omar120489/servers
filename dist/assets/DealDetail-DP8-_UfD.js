import{importShared as v}from"./__federation_fn_import-CJIdJiQv.js";import{j as e}from"./useForkRef-BC7kqYKT.js";import{i as X}from"./axios-CKLPSsiI.js";import{u as Y,C as Z,A as ee,a as te}from"./useJourneyEvents-BqTmzo4O.js";import{M as se}from"./MainCard-BRoTQIrC.js";import{d as N}from"./deals-BUIaxD3R.js";import{G as r}from"./GridLegacy-DgbSh-o7.js";import{T as a}from"./Typography-DFd_zA1D.js";import{C as S}from"./Chip-clCeHopq.js";import{B as f}from"./Box-DmbfI6Tx.js";import{d as b,C as ae}from"./Button-Bgis-uOM.js";import{a as ne,T as k}from"./Tab-DFFX6k-o.js";import{A as oe}from"./Alert-C9XT2yne.js";const{useMemo:F,useState:$}=await v("react"),{Dialog:re,DialogTitle:ie,DialogContent:le,DialogActions:de,Button:I,TextField:B,Stack:E,Typography:W}=await v("@mui/material");function ce({open:s,onClose:l,onConfirm:t}){const[d,m]=$(""),[x,u]=$(""),o=Number(d),i=Number(x),h=F(()=>Number.isFinite(o)&&o>0&&Number.isFinite(i)&&i>0,[o,i]),c=F(()=>h?o-i:null,[h,o,i]),g=()=>{h&&t({grossRevenue:o,directCost:i})};return e.jsxs(re,{open:s,onClose:l,fullWidth:!0,maxWidth:"sm",children:[e.jsx(ie,{children:"Closed Won – Financials Required"}),e.jsx(le,{dividers:!0,children:e.jsxs(E,{spacing:2,sx:{pt:1},children:[e.jsxs(W,{variant:"body2",color:"text.secondary",children:["To mark this deal as ",e.jsx("strong",{children:"Closed Won"}),", please enter the financials (used for P&L tracking)."]}),e.jsx(B,{label:"Gross Revenue",type:"number",required:!0,slotProps:{htmlInput:{min:.01,step:"0.01"}},value:d,onChange:C=>m(C.target.value),helperText:"Required and must be greater than 0",error:!!d&&o<=0,size:"small"}),e.jsx(B,{label:"Direct Cost",type:"number",required:!0,slotProps:{htmlInput:{min:.01,step:"0.01"}},value:x,onChange:C=>u(C.target.value),helperText:"Required and must be greater than 0",error:!!x&&i<=0,size:"small"}),e.jsxs(E,{direction:"row",alignItems:"baseline",spacing:1,children:[e.jsx(W,{variant:"subtitle2",children:"Net Profit:"}),e.jsx(W,{variant:"h6",children:c===null?"—":c.toLocaleString(void 0,{style:"currency",currency:"USD"})})]})]})}),e.jsxs(de,{children:[e.jsx(I,{onClick:l,color:"inherit",children:"Cancel"}),e.jsx(I,{onClick:g,variant:"contained",disabled:!h,children:"Confirm & Mark Won"})]})]})}const{useState:z,useMemo:ue,useEffect:xe}=await v("react"),{Button:q,Dialog:me,DialogActions:he,DialogContent:ye,DialogTitle:fe,FormControl:je,InputLabel:pe,MenuItem:be,Select:ve,Stack:ge,TextField:Ce,Typography:De}=await v("@mui/material"),ke=[{value:"L-Price/Budget",label:"Price/Budget"},{value:"L-Timing/Postponed",label:"Timing/Postponed"},{value:"L-Qualification/Not a fit",label:"Qualification/Not a fit"},{value:"L-Competitor",label:"Competitor"},{value:"L-No response",label:"No response"},{value:"L-Other",label:"Other"}];function we({open:s,onClose:l,onConfirm:t}){const[d,m]=z(""),[x,u]=z(""),o=ue(()=>!!d,[d]);xe(()=>{s||(m(""),u(""))},[s]);const i=()=>{o&&t({lossReason:d,lossNotes:x.trim()||void 0})},h=()=>{l()};return e.jsxs(me,{open:s,onClose:h,maxWidth:"sm",fullWidth:!0,children:[e.jsx(fe,{children:"Mark Deal as Lost"}),e.jsx(ye,{children:e.jsxs(ge,{spacing:2,sx:{pt:1},children:[e.jsx(De,{variant:"body2",color:"text.secondary",children:"Please select a reason for marking this deal as lost. This helps track why deals are not closing."}),e.jsxs(je,{fullWidth:!0,required:!0,children:[e.jsx(pe,{id:"loss-reason-label",children:"Loss Reason"}),e.jsx(ve,{labelId:"loss-reason-label",id:"loss-reason",value:d,onChange:c=>m(c.target.value),label:"Loss Reason",children:ke.map(c=>e.jsx(be,{value:c.value,children:c.label},c.value))})]}),e.jsx(Ce,{fullWidth:!0,multiline:!0,rows:3,label:"Additional Notes (Optional)",placeholder:"Add any additional context about why this deal was lost...",value:x,onChange:c=>u(c.target.value),helperText:"Optional: Provide more details about the loss reason"})]})}),e.jsxs(he,{sx:{px:3,pb:2},children:[e.jsx(q,{onClick:h,color:"secondary",children:"Cancel"}),e.jsx(q,{onClick:i,variant:"contained",disabled:!o,children:"Confirm & Mark Lost"})]})]})}const{useCallback:Re,useEffect:Te,useMemo:Le,useState:j}=await v("react"),{useNavigate:Ae,useParams:Ne}=await v("react-router-dom");function w(s){return s==null||Number.isNaN(s)?"—":new Intl.NumberFormat(void 0,{style:"currency",currency:"USD",maximumFractionDigits:2}).format(s)}function Se(s){if(s==null||Number.isNaN(s))return"—";const l=s>1?s:s*100;return`${Math.round(l)}%`}function O(s){return s?new Intl.DateTimeFormat(void 0,{year:"numeric",month:"short",day:"numeric"}).format(new Date(s)):"—"}function We(s){if(!s)return!1;const l=/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-5][0-9a-fA-F]{3}-[089abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}$/,t=/^\d+$/;return l.test(s)||t.test(s)}function Qe(){const{id:s}=Ne(),l=Ae(),[t,d]=j(null),[m,x]=j(!0),[u,o]=j(null),[i,h]=j("summary"),[c,g]=j(!1),[C,R]=j(!1),[T,D]=j(!1),p=Y({entityType:"deal",entityId:s||""}),L=Re(async()=>{if(!We(s)){o({kind:"not-found",message:"The requested deal could not be found."}),x(!1);return}x(!0);try{const n=await N.getDeal(s);d(n),o(null)}catch(n){X(n)?n.response?.status===404?o({kind:"not-found",message:"The requested deal could not be found."}):o({kind:"network",message:n.response?.data?.message??"We could not load this deal. Please try again in a moment."}):o({kind:"network",message:"We could not load this deal. Please try again in a moment."})}finally{x(!1)}},[s]);Te(()=>{L()},[L]);const P=()=>{g(!0)},G=async n=>{if(t?.id){g(!1),D(!0);try{const y=t.status,A=await N.updateDeal(t.id,{status:"Closed Won",grossRevenue:n.grossRevenue,directCost:n.directCost});d(A),await p.addEvent({type:"deal_won",payload:{from:y,to:"Closed Won",grossRevenue:n.grossRevenue,directCost:n.directCost,netProfit:n.grossRevenue-n.directCost}})}catch(y){console.error("Failed to update deal:",y)}finally{D(!1)}}},U=()=>{g(!1)},M=()=>{R(!0)},_=async n=>{if(t?.id){R(!1),D(!0);try{const y=t.status,A=await N.updateDeal(t.id,{status:"Lost",lossReason:n.lossReason,lossNotes:n.lossNotes});d(A),await p.addEvent({type:"deal_lost",payload:{from:y,to:"Lost",reason:n.lossReason,notes:n.lossNotes}})}catch(y){console.error("Failed to update deal:",y)}finally{D(!1)}}},Q=()=>{R(!1)},J=Le(()=>t?e.jsxs(r,{container:!0,spacing:2,sx:{mt:0},children:[e.jsxs(r,{xs:12,sx:{display:"flex",flexDirection:"column",gap:.5},children:[e.jsx(a,{variant:"h4",children:t.name}),e.jsxs(a,{variant:"body2",color:"text.secondary",children:["Deal ID: ",t.id]})]}),e.jsxs(r,{xs:12,md:6,children:[e.jsx(a,{variant:"subtitle2",color:"text.secondary",children:"Amount"}),e.jsx(a,{variant:"body1",children:w(t.amount)})]}),e.jsxs(r,{xs:12,md:6,children:[e.jsx(a,{variant:"subtitle2",color:"text.secondary",children:"Stage"}),e.jsx(S,{label:t.stage??"—",variant:"outlined",size:"small"})]}),e.jsxs(r,{xs:12,md:6,children:[e.jsx(a,{variant:"subtitle2",color:"text.secondary",children:"Status"}),e.jsxs(f,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(S,{label:t.status??"—",color:"primary",size:"small",variant:"outlined"}),t.status!=="Closed Won"&&t.status!=="Won"&&t.status!=="Lost"&&e.jsxs(e.Fragment,{children:[e.jsx(b,{size:"small",variant:"outlined",onClick:P,disabled:T,children:"Mark Won"}),e.jsx(b,{size:"small",variant:"outlined",color:"error",onClick:M,disabled:T,children:"Mark Lost"})]}),t.status==="Lost"&&t.lossReason&&e.jsx(S,{label:t.lossReason.replace("L-",""),color:"error",size:"small",variant:"filled"})]})]}),e.jsxs(r,{xs:12,md:6,children:[e.jsx(a,{variant:"subtitle2",color:"text.secondary",children:"Probability"}),e.jsx(a,{variant:"body1",children:Se(t.probability)})]}),e.jsxs(r,{xs:12,md:6,children:[e.jsx(a,{variant:"subtitle2",color:"text.secondary",children:"Close Date"}),e.jsx(a,{variant:"body1",children:O(t.closeDate)})]}),e.jsxs(r,{xs:12,md:6,children:[e.jsx(a,{variant:"subtitle2",color:"text.secondary",children:"Owner"}),e.jsx(a,{variant:"body1",children:t.ownerId})]}),e.jsxs(r,{xs:12,md:6,children:[e.jsx(a,{variant:"subtitle2",color:"text.secondary",children:"Company"}),e.jsx(a,{variant:"body1",children:t.companyId??"—"})]}),e.jsxs(r,{xs:12,md:6,children:[e.jsx(a,{variant:"subtitle2",color:"text.secondary",children:"Contact"}),e.jsx(a,{variant:"body1",children:t.contactId??"—"})]}),e.jsxs(r,{xs:12,md:6,children:[e.jsx(a,{variant:"subtitle2",color:"text.secondary",children:"Updated At"}),e.jsx(a,{variant:"body1",children:O(t.updatedAt)})]}),e.jsxs(r,{xs:12,children:[e.jsx(a,{variant:"subtitle2",color:"text.secondary",children:"Description"}),e.jsx(a,{variant:"body1",children:t.description??"—"})]}),t.grossRevenue!==null&&t.grossRevenue!==void 0&&e.jsxs(e.Fragment,{children:[e.jsx(r,{xs:12,children:e.jsx(a,{variant:"h6",sx:{mt:2,mb:1},children:"Financial Details"})}),e.jsxs(r,{xs:12,md:4,children:[e.jsx(a,{variant:"subtitle2",color:"text.secondary",children:"Gross Revenue"}),e.jsx(a,{variant:"body1",children:w(t.grossRevenue)})]}),e.jsxs(r,{xs:12,md:4,children:[e.jsx(a,{variant:"subtitle2",color:"text.secondary",children:"Direct Cost"}),e.jsx(a,{variant:"body1",children:w(t.directCost)})]}),e.jsxs(r,{xs:12,md:4,children:[e.jsx(a,{variant:"subtitle2",color:"text.secondary",children:"Net Profit"}),e.jsx(a,{variant:"h6",sx:{color:(t.netProfit??0)>=0?"success.main":"error.main"},children:w(t.netProfit)})]})]})]}):null,[t,T,P,M]),V=e.jsx(f,{sx:{p:3},children:e.jsx(te,{events:p.events,loading:p.loading,error:p.error,onRetry:p.refresh})}),H=!s,K=!s;return e.jsxs(se,{title:"Deal Details",secondary:e.jsxs(f,{sx:{display:"flex",gap:1},children:[e.jsx(b,{variant:"outlined",onClick:()=>l(-1),children:"Back"}),s&&e.jsx(b,{variant:"contained",color:"secondary",onClick:()=>l(`/deals/${s}/edit`),children:"Edit Deal"})]}),children:[e.jsxs(ne,{value:i,onChange:(n,y)=>h(y),variant:"scrollable",allowScrollButtonsMobile:!0,sx:{borderBottom:n=>`1px solid ${n.palette.divider}`,mb:2},children:[e.jsx(k,{label:"Summary",value:"summary"}),e.jsx(k,{label:"Activity",value:"activity"}),e.jsx(k,{label:"Comments",value:"comments",disabled:H}),e.jsx(k,{label:"Attachments",value:"attachments",disabled:K})]}),m&&e.jsx(f,{sx:{display:"flex",justifyContent:"center",py:6},children:e.jsx(ae,{})}),!m&&u&&e.jsxs(oe,{severity:u.kind==="network"?"error":"warning",children:[e.jsx(a,{variant:"body2",sx:{mb:1},children:u.message}),e.jsxs(f,{sx:{display:"flex",gap:1,flexWrap:"wrap"},children:[u.kind==="network"&&e.jsx(b,{size:"small",onClick:()=>void L(),variant:"outlined",children:"Retry"}),e.jsx(b,{size:"small",variant:"contained",onClick:()=>l("/deals"),children:"Back to Deals"})]})]}),!m&&!u&&t&&e.jsxs(f,{children:[i==="summary"&&J,i==="activity"&&V,i==="comments"&&s&&e.jsx(Z,{entityType:"deal",entityId:s,title:"Comments"}),i==="attachments"&&s&&e.jsx(ee,{entityType:"deal",entityId:s,title:"Attachments"})]}),!m&&!u&&!t&&e.jsx(f,{sx:{py:4},children:e.jsx(a,{variant:"body2",color:"text.secondary",textAlign:"center",children:"We could not find details for this deal."})}),e.jsx(ce,{open:c,onClose:U,onConfirm:G}),e.jsx(we,{open:C,onClose:Q,onConfirm:_})]})}export{Qe as default};
//# sourceMappingURL=DealDetail-DP8-_UfD.js.map
