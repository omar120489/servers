const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-BmdtOiXx.js","assets/__federation_fn_import-CJIdJiQv.js","assets/emotion-use-insertion-effect-with-fallbacks.browser.esm-DrMHPVRy.js","assets/Button-Bgis-uOM.js","assets/useForkRef-BC7kqYKT.js","assets/emotion-element-f0de968e.browser.esm-BwBurgiu.js","assets/_commonjsHelpers-DaWZu8wl.js","assets/__federation_shared_@emotion/react-B0srcFAv.js","assets/useFocusedItem-BspZmdkd.js","assets/index-CNUC8Y_i.js","assets/NoSsr-BEcnbA1C.js","assets/useThemeProps-BI4UimO6.js","assets/getThemeProps-DXGZU7it.js","assets/useTheme-kfTkFvI8.js","assets/Portal-DGTWBSOi.js","assets/mergeSlotProps-InYe3CaG.js","assets/Typography-DFd_zA1D.js","assets/index-CdltjdKQ.js","assets/index-DIFXkSDU.js","assets/isDeepEqual-CqtrkwLL.js","assets/index-CMF_dOlt.js","assets/index-PQkH_WQI.js","assets/Popper-DBpylNoV.js","assets/ownerDocument-DW-IO8s5.js","assets/IconButton-BEyrMm9G.js","assets/ownerWindow-HkKU3E4x.js","assets/index-C3p1YbKA.js","assets/index-BjfUBotL.js"])))=>i.map(i=>d[i]);
import{_ as xe}from"./preload-helper-BXl3LOEh.js";import{importShared as fe}from"./__federation_fn_import-CJIdJiQv.js";import{j as e}from"./useForkRef-BC7kqYKT.js";import{M as Se}from"./MainCard-BRoTQIrC.js";import{D as Fe}from"./deals-BjCyASoR.js";import{a as N}from"./axios-CKLPSsiI.js";import{B as U}from"./Box-DmbfI6Tx.js";import{C as ce,d as de}from"./Button-Bgis-uOM.js";import{S as $}from"./Stack-B5BVBH1D.js";import{T as S}from"./TextField-HqD_g_zo.js";import{M as P}from"./MenuItem-D9vzE7eA.js";import{A as Ae}from"./Alert-C9XT2yne.js";import{G as y}from"./GridLegacy-DgbSh-o7.js";import{C as p,a as g}from"./CardContent-CBXeKjeK.js";import{C as G}from"./CardActionArea-DemLmsLU.js";import{T as i}from"./Typography-DFd_zA1D.js";import{D as J}from"./Divider-DT_KIT_t.js";import{b as ke,T as De,c as Le,d as ue,a as Re}from"./TableRow-DYcKugvt.js";import{P as Pe}from"./Paper-CeqRlO8T.js";import{a as b}from"./TableCell-DUk3nzYY.js";function W(n){const r={};return Object.entries(n).forEach(([a,s])=>{s!=null&&s!==""&&(r[a]=s)}),r}async function Ee(n){return N("/api/reporting/kpis",{params:W(n)})}async function _e(n){return N("/api/reporting/funnel",{params:W(n)})}async function Ne(n,r="day"){return N("/api/reporting/trends",{params:{...W(n),interval:r}})}async function We(n,r="month"){return N("/api/reporting/cohorts",{params:{...W(n),interval:r}})}function Oe(n){if(n.length===0)return{xAxis:[],series:[]};const r=Array.from(new Set(n.map(l=>l.date))).sort((l,m)=>new Date(l).getTime()-new Date(m).getTime()),a=r.map(l=>new Date(l)),s=new Map;r.forEach(()=>{s.forEach((l,m)=>{l.push(null),s.set(m,l)})}),n.forEach(l=>{const m=l.seriesKey??"default";s.has(m)||s.set(m,Array(r.length).fill(null));const x=s.get(m),k=r.indexOf(l.date);k>=0&&(x[k]=l.value)});const C=Array.from(s.entries()).map(([l,m])=>({id:l,label:l==="default"?"Value":l,data:m,connectNulls:!0}));return{xAxis:a,series:C}}function Ke(n){if(n.length===0)return{categories:[],counts:[],conversionRates:[]};const r=[...n].sort((a,s)=>s.count-a.count);return{categories:r.map(a=>a.name),counts:r.map(a=>a.count),conversionRates:r.map(a=>a.conversionRate)}}function ze(n){return n.length===0?[]:[...n].sort((r,a)=>r.cohortKey.localeCompare(a.cohortKey)).map(r=>({cohortKey:r.cohortKey,total:r.total,converted:r.converted,conversionRate:r.conversionRate}))}const{lazy:pe,Suspense:he,useCallback:h,useEffect:me,useMemo:v,useRef:Y,useState:F}=await fe("react"),{useNavigate:Me,useSearchParams:Ve}=await fe("react-router-dom"),q={dateFrom:null,dateTo:null,source:null,ownerId:null,stage:null},X="day",_="analytics.filters";function A(n){if(typeof n!="string")return null;const r=n.trim();return r.length>0?r:null}function Be(n){const r=a=>A(n.get(a));return{dateFrom:r("dateFrom"),dateTo:r("dateTo"),source:r("source"),ownerId:r("ownerId"),stage:r("stage")}}function Ue(n){const r=n.get("interval");return r==="week"||r==="month"?r:X}function $e(){if(typeof window>"u")return null;try{const n=window.localStorage.getItem(_);if(!n)return null;const r=JSON.parse(n);return{dateFrom:A(r.dateFrom),dateTo:A(r.dateTo),source:A(r.source),ownerId:A(r.ownerId),stage:A(r.stage)}}catch{return null}}function Ge(n,r){return r?{dateFrom:n.dateFrom??r.dateFrom??null,dateTo:n.dateTo??r.dateTo??null,source:n.source??r.source??null,ownerId:n.ownerId??r.ownerId??null,stage:n.stage??r.stage??null}:n}function H(n,r){const a=new URLSearchParams;return Object.entries(n).forEach(([s,C])=>{C&&a.set(s,C)}),a.set("interval",r),a}function Je(n,r={}){const a={...n,...r},s=new URLSearchParams;return a.dateFrom&&s.set("dateFrom",a.dateFrom),a.dateTo&&s.set("dateTo",a.dateTo),a.stage&&s.set("stage",a.stage),a.ownerId&&s.set("ownerId",a.ownerId),a.source&&s.set("search",a.source),s}function Ye(n){return n.toISOString().slice(0,10)}const qe=pe(async()=>({default:(await xe(()=>import("./index-BmdtOiXx.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26]))).LineChart})),He=pe(async()=>({default:(await xe(()=>import("./index-BjfUBotL.js"),__vite__mapDeps([27,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25]))).BarChart})),Qe=qe,Xe=He,Q={leadsCreated:"kpi-leads-created",dealsCreated:"kpi-deals-created",dealsWon:"kpi-deals-won"};function yt(){const[n,r]=Ve(),a=Me(),s=Y(void 0);s.current===void 0&&(s.current=$e());const C=Y(null);C.current===null&&(C.current=Ge(Be(n),s.current??null));const l=Y(Ue(n)),m=C.current??q,[x,k]=F(m),[f,Z]=F(m),[D,ee]=F(l.current),[d,ge]=F({kpis:null,funnel:[],trends:[],cohorts:[]}),[O,te]=F(!1),[K,re]=F(null),ne=v(()=>JSON.stringify(x)!==JSON.stringify(f),[x,f]),L=v(()=>Oe(d.trends),[d.trends]),E=v(()=>Ke(d.funnel),[d.funnel]),ae=v(()=>ze(d.cohorts),[d.cohorts]),se=h(async(t,o)=>{te(!0),re(null);try{const[c,u,j,B]=await Promise.all([Ee(t),_e(t),Ne(t,o),We(t)]);ge({kpis:c,funnel:u,trends:j,cohorts:B})}catch(c){re(c instanceof Error?c.message:"Unable to load analytics data.")}finally{te(!1)}},[]);me(()=>{se(f,D)},[f,D,se]),me(()=>{if(typeof window>"u")return;const{dateFrom:t,dateTo:o,source:c,ownerId:u,stage:j}=f;if(!t&&!o&&!c&&!u&&!j){window.localStorage.removeItem(_);return}window.localStorage.setItem(_,JSON.stringify(f))},[f]);const z=v(()=>new Intl.DateTimeFormat(void 0,{year:"numeric",month:"short",day:"numeric"}),[]),oe=v(()=>new Intl.NumberFormat(void 0,{notation:"compact",maximumFractionDigits:1}),[]),M=h(t=>{if(t instanceof Date)return z.format(t);if(typeof t=="string"||typeof t=="number"){const o=new Date(t);if(!Number.isNaN(o.getTime()))return z.format(o)}return""},[z]),I=h(t=>typeof t=="number"&&Number.isFinite(t)?oe.format(t):"",[oe]),je=v(()=>({tooltip:{labelFormatter:t=>M(t.value),valueFormatter:t=>I(t)}}),[M,I]),ye=v(()=>({tooltip:{valueFormatter:t=>I(t)}}),[I]),ie=v(()=>e.jsx(U,{sx:{display:"flex",alignItems:"center",justifyContent:"center",height:320},children:e.jsx(ce,{size:24})}),[]),R=h((t,o)=>{const c=o.trim();k(u=>({...u,[t]:c===""?null:c}))},[]),ve=h(()=>{Z(x),r(H(x,D))},[x,D,r]),Ce=h(()=>{const t={...q};k(t),Z(t),ee(X),r(H(q,X)),typeof window<"u"&&window.localStorage.removeItem(_)},[r]),Te=h(t=>{const o=t.target.value;ee(o),r(H(f,o))},[f,r]),le=h((t={})=>Je(f,t),[f]),T=h((t,o={})=>{const u=le(o).toString();a(u?`/${t}?${u}`:`/${t}`)},[le,a]),V=h(t=>t&&String(t).toLowerCase().includes("lead")?"leads":"deals",[]),be=h((t,o)=>{const c=L.xAxis[o];if(!c)return;const u=V(t),j=Ye(c);T(u,{dateFrom:j,dateTo:j})},[V,T,L]),Ie=h(()=>{T("leads")},[T]),we=h(()=>{T("deals")},[T]),w=(t,o)=>o?o(t):t.toLocaleString();return e.jsx(Se,{title:"Analytics",children:e.jsxs($,{spacing:3,children:[e.jsxs($,{direction:{xs:"column",md:"row"},spacing:2,alignItems:{xs:"stretch",md:"flex-end"},children:[e.jsx(S,{type:"date",label:"Date From",value:x.dateFrom??"",onChange:t=>R("dateFrom",t.target.value),InputLabelProps:{shrink:!0},sx:{minWidth:200}}),e.jsx(S,{type:"date",label:"Date To",value:x.dateTo??"",onChange:t=>R("dateTo",t.target.value),InputLabelProps:{shrink:!0},sx:{minWidth:200}}),e.jsx(S,{label:"Source",placeholder:"All sources",value:x.source??"",onChange:t=>R("source",t.target.value),sx:{minWidth:200}}),e.jsxs(S,{select:!0,label:"Stage",value:x.stage??"",onChange:t=>R("stage",t.target.value),sx:{minWidth:200},children:[e.jsx(P,{value:"",children:"All stages"}),Fe.map(t=>e.jsx(P,{value:t,children:t},t))]}),e.jsx(S,{label:"Owner ID",placeholder:"Owner UUID",value:x.ownerId??"",onChange:t=>R("ownerId",t.target.value),sx:{minWidth:200}}),e.jsxs(S,{select:!0,label:"Trend Interval",value:D,onChange:Te,sx:{minWidth:160},children:[e.jsx(P,{value:"day",children:"Daily"}),e.jsx(P,{value:"week",children:"Weekly"}),e.jsx(P,{value:"month",children:"Monthly"})]}),e.jsxs(U,{sx:{display:"flex",gap:1},children:[e.jsx(de,{variant:"contained",onClick:ve,disabled:!ne,children:"Apply"}),e.jsx(de,{variant:"outlined",onClick:Ce,disabled:!ne,children:"Reset"})]})]}),O&&e.jsx(U,{sx:{display:"flex",justifyContent:"center",py:6},children:e.jsx(ce,{})}),!O&&K&&e.jsx(Ae,{severity:"error",children:K}),!O&&!K&&e.jsxs($,{spacing:3,children:[e.jsx(y,{container:!0,spacing:2,children:d.kpis?e.jsxs(e.Fragment,{children:[e.jsx(y,{xs:12,sm:6,md:3,children:e.jsx(p,{variant:"outlined",children:e.jsx(G,{"data-testid":Q.leadsCreated,onClick:Ie,children:e.jsxs(g,{children:[e.jsx(i,{variant:"subtitle2",color:"text.secondary",children:"Leads Created"}),e.jsx(i,{variant:"h4",children:w(d.kpis.leadsCreated)})]})})})}),e.jsx(y,{xs:12,sm:6,md:3,children:e.jsx(p,{variant:"outlined",children:e.jsx(G,{"data-testid":Q.dealsCreated,onClick:we,children:e.jsxs(g,{children:[e.jsx(i,{variant:"subtitle2",color:"text.secondary",children:"Deals Created"}),e.jsx(i,{variant:"h4",children:w(d.kpis.dealsCreated)})]})})})}),e.jsx(y,{xs:12,sm:6,md:3,children:e.jsx(p,{variant:"outlined",children:e.jsx(G,{"data-testid":Q.dealsWon,onClick:()=>T("deals",{stage:"Closed Won"}),children:e.jsxs(g,{children:[e.jsx(i,{variant:"subtitle2",color:"text.secondary",children:"Deals Won"}),e.jsx(i,{variant:"h4",children:w(d.kpis.dealsWon)})]})})})}),e.jsx(y,{xs:12,sm:6,md:3,children:e.jsx(p,{variant:"outlined",children:e.jsxs(g,{children:[e.jsx(i,{variant:"subtitle2",color:"text.secondary",children:"Win Rate"}),e.jsx(i,{variant:"h4",children:w(d.kpis.winRate,t=>`${t.toFixed(1)}%`)})]})})}),e.jsx(y,{xs:12,sm:6,md:3,children:e.jsx(p,{variant:"outlined",children:e.jsxs(g,{children:[e.jsx(i,{variant:"subtitle2",color:"text.secondary",children:"Avg. Cycle (days)"}),e.jsx(i,{variant:"h4",children:w(d.kpis.avgCycleDays,t=>t.toFixed(1))})]})})}),typeof d.kpis.revenue=="number"&&e.jsx(y,{xs:12,sm:6,md:3,children:e.jsx(p,{variant:"outlined",children:e.jsxs(g,{children:[e.jsx(i,{variant:"subtitle2",color:"text.secondary",children:"Revenue"}),e.jsxs(i,{variant:"h4",children:["$",d.kpis.revenue.toLocaleString()]})]})})}),typeof d.kpis.roas=="number"&&e.jsx(y,{xs:12,sm:6,md:3,children:e.jsx(p,{variant:"outlined",children:e.jsxs(g,{children:[e.jsx(i,{variant:"subtitle2",color:"text.secondary",children:"ROAS"}),e.jsx(i,{variant:"h4",children:w(d.kpis.roas,t=>`${t.toFixed(2)}x`)})]})})})]}):e.jsx(y,{xs:12,children:e.jsx(p,{variant:"outlined",children:e.jsx(g,{children:e.jsx(i,{color:"text.secondary",children:"No KPI data available."})})})})}),e.jsx(p,{variant:"outlined",children:e.jsxs(g,{children:[e.jsx(i,{variant:"h6",children:"Trends"}),e.jsx(i,{variant:"body2",color:"text.secondary",children:"Performance across the selected date range."}),e.jsx(J,{sx:{my:2}}),L.series.length===0?e.jsx(i,{color:"text.secondary",children:"No trend data for the selected filters."}):e.jsx(he,{fallback:ie,children:e.jsx(Qe,{height:320,xAxis:[{data:L.xAxis,scaleType:"time",valueFormatter:t=>M(t)}],series:L.series.map(t=>({...t,valueFormatter:o=>I(o)})),onItemClick:(t,o)=>{const{seriesId:c,dataIndex:u}=o??{};typeof u=="number"&&be(c,u)},slotProps:je})})]})}),e.jsx(p,{variant:"outlined",children:e.jsxs(g,{children:[e.jsx(i,{variant:"h6",children:"Funnel"}),e.jsx(i,{variant:"body2",color:"text.secondary",children:"Conversion through each stage."}),e.jsx(J,{sx:{my:2}}),E.categories.length===0?e.jsx(i,{color:"text.secondary",children:"No funnel data for the selected filters."}):e.jsx(he,{fallback:ie,children:e.jsx(Xe,{height:320,xAxis:[{scaleType:"band",data:E.categories}],series:[{data:E.counts,label:"Deals",valueFormatter:t=>I(t)}],onItemClick:(t,o)=>{const{seriesId:c,dataIndex:u}=o??{};if(typeof u!="number")return;const j=E.categories[u];if(!j)return;const B=V(c);T(B,{stage:j})},slotProps:ye})})]})}),e.jsx(p,{variant:"outlined",children:e.jsxs(g,{children:[e.jsx(i,{variant:"h6",children:"Cohorts"}),e.jsx(i,{variant:"body2",color:"text.secondary",children:"Cohort performance over time."}),e.jsx(J,{sx:{my:2}}),ae.length===0?e.jsx(i,{color:"text.secondary",children:"No cohort data for the selected filters."}):e.jsx(ke,{component:Pe,variant:"outlined",children:e.jsxs(De,{size:"small",children:[e.jsx(Le,{children:e.jsxs(ue,{children:[e.jsx(b,{children:"Cohort"}),e.jsx(b,{align:"right",children:"Total"}),e.jsx(b,{align:"right",children:"Converted"}),e.jsx(b,{align:"right",children:"Conversion"})]})}),e.jsx(Re,{children:ae.map(t=>e.jsxs(ue,{hover:!0,children:[e.jsx(b,{children:t.cohortKey}),e.jsx(b,{align:"right",children:t.total.toLocaleString()}),e.jsx(b,{align:"right",children:t.converted.toLocaleString()}),e.jsxs(b,{align:"right",children:[t.conversionRate.toFixed(1),"%"]})]},t.cohortKey))})]})})]})})]})]})})}export{yt as default};
//# sourceMappingURL=AnalyticsDashboard-CB20ry8q.js.map
